#!/bin/sh
set -e

ENV=${1:-staging}
SKIP_CI=${2:-nope}

if [ $SKIP_CI != '--now' ]
  # run CI
  then script/ci || exit
fi

# update local tags
git fetch --tags

# push to github
git push $ENV master || exit

# tag this rev as having been released
git push --delete origin latest-$ENV
git tag -f latest-$ENV
git push --tags

# tell honeybadger we deploy'd
rake honeybadger:deploy TO=production REVISION=`git rev-parse HEAD` USER=`git config user.name`
